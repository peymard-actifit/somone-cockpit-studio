# Règles de sécurité pour le Build et le Déploiement

## Règle CRITIQUE - Stabilité de production

**AVANT toute modification de ces fichiers, TESTER LOCALEMENT :**
- `api/index.ts` - API backend (NE PAS MODULARISER sans test Vercel)
- `vite.config.ts` - Configuration build
- `package.json` - Dépendances
- `tsconfig.json` - TypeScript

## API Backend - LIMITATIONS VERCEL

### Ce qui NE FONCTIONNE PAS avec Vercel Serverless :
1. **Imports depuis sous-dossiers** (`api/_lib/`, `api/lib/`) - Vercel ne les bundle pas
2. **Architecture multi-fichiers avec code partagé** - Les imports relatifs échouent
3. **Imports depuis src/** - Les fonctions serverless sont isolées

### Ce qui FONCTIONNE :
1. **Un seul fichier monolithique** `api/index.ts` avec tout le code
2. **Imports depuis node_modules** (npm packages)
3. **Multi-fichiers SANS code partagé** (duplication acceptable pour petites routes)

### Conclusion
Le fichier `api/index.ts` doit rester **monolithique** (~9000 lignes).
C'est une contrainte de Vercel, pas un choix d'architecture.

## Configuration Vite - manualChunks

### INTERDIT
```typescript
// ❌ NE JAMAIS séparer React et ses dépendances directes
manualChunks: {
  'react-vendor': ['react', 'react-dom'],  // DANGER
  'dnd-kit': ['@dnd-kit/core'],            // DANGER - dépend de React
  'zustand': ['zustand'],                   // DANGER - dépend de React
}
```

### AUTORISÉ
```typescript
// ✅ Séparer UNIQUEMENT les libs avec import dynamique (await import)
manualChunks: (id) => {
  // Libs importées via await import() uniquement
  if (id.includes('jspdf')) return 'pdf-libs';
  if (id.includes('pptxgenjs')) return 'pptx-libs';
  if (id.includes('html2canvas')) return 'html2canvas';
}
```

## Vérification avant déploiement

Avant tout déploiement, vérifier :

1. **Build local** : `npm run build` doit réussir sans erreur
2. **TypeScript** : `npx tsc --noEmit` doit passer
3. **Test manuel** : Ouvrir `dist/index.html` localement si possible

## Règles pour les imports dynamiques

- Les `await import('...')` peuvent être mis dans des chunks séparés
- Les `import ... from '...'` statiques NE DOIVENT PAS être séparés de leur dépendances
- Ne JAMAIS séparer une lib qui dépend de React dans un chunk différent de React

## En cas d'erreur en production

1. Rollback immédiat vers la dernière version stable
2. Analyser l'erreur dans la console
3. Corriger et tester localement
4. Re-déployer
